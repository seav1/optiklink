name: Auto Login with Cookie

on:
  schedule:
    # æ¯å¤©è¿è¡Œä¸€æ¬¡ï¼ŒåŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹ï¼ˆUTC 1:00ï¼‰
    - cron: '0 1 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  login:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login and Update Cookie
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          REPO: ${{ github.repository }}
        run: |
          echo "å¼€å§‹ç™»å½•..."
          
          # ä» GitHub Secrets è¯»å–å½“å‰ Cookie
          COOKIE="${{ secrets.LOGIN_COOKIE }}"
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨ Cookie
          COOKIE_FILE=$(mktemp)
          
          # ä½¿ç”¨ curl å‘é€è¯·æ±‚å¹¶ä¿å­˜æ–°çš„ Cookie
          response=$(curl -s -w "\n%{http_code}" -L \
            -c "$COOKIE_FILE" \
            -b "$COOKIE" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8" \
            -H "Accept-Language: zh-CN,zh;q=0.9,en;q=0.8" \
            -H "Referer: https://optiklink.com/auth" \
            "https://optiklink.com/")
          
          # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "HTTP çŠ¶æ€ç : $http_code"
          
          # ä» Cookie æ–‡ä»¶ä¸­æå–æ–°çš„ Cookie
          NEW_COOKIE=""
          if [ -f "$COOKIE_FILE" ]; then
            echo "æå–æ–°çš„ Cookie..."
            
            # è§£æ cookie æ–‡ä»¶ï¼Œæ ¼å¼åŒ–ä¸ºæµè§ˆå™¨æ ¼å¼
            while IFS=$'\t' read -r domain flag path secure expiration name value; do
              # è·³è¿‡æ³¨é‡Šè¡Œå’Œç©ºè¡Œ
              if [[ "$domain" == \#* ]] || [ -z "$domain" ]; then
                continue
              fi
              
              # æ„å»º cookie å­—ç¬¦ä¸²
              if [ -n "$NEW_COOKIE" ]; then
                NEW_COOKIE="$NEW_COOKIE; $name=$value"
              else
                NEW_COOKIE="$name=$value"
              fi
            done < "$COOKIE_FILE"
            
            echo "æ–° Cookie å·²æå–"
            echo "Cookie é•¿åº¦: ${#NEW_COOKIE}"
          fi
          
          # æ£€æŸ¥æ˜¯å¦ç™»å½•æˆåŠŸ
          if [ "$http_code" = "200" ]; then
            echo "âœ… ç™»å½•æˆåŠŸï¼"
            echo "ç™»å½•æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            
            # å¦‚æœè·å–åˆ°æ–°çš„ Cookieï¼Œæ›´æ–° GitHub Secret
            if [ -n "$NEW_COOKIE" ] && [ ${#NEW_COOKIE} -gt 10 ]; then
              echo "æ­£åœ¨æ›´æ–° GitHub Secret..."
              
              # è·å– Secret çš„å…¬é’¥
              pub_key_response=$(curl -s -H "Authorization: token $GH_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/$REPO/actions/secrets/public-key")
              
              key_id=$(echo "$pub_key_response" | grep -o '"key_id":"[^"]*' | cut -d'"' -f4)
              public_key=$(echo "$pub_key_response" | grep -o '"key":"[^"]*' | cut -d'"' -f4)
              
              if [ -n "$key_id" ] && [ -n "$public_key" ]; then
                # ä½¿ç”¨ Python åŠ å¯† Secretï¼ˆGitHub API è¦æ±‚ä½¿ç”¨ libsodium åŠ å¯†ï¼‰
                encrypted_value=$(python3 << EOF
import base64
import json
from nacl import encoding, public

def encrypt_secret(public_key: str, secret_value: str) -> str:
    public_key_bytes = base64.b64decode(public_key)
    public_key_obj = public.PublicKey(public_key_bytes)
    sealed_box = public.SealedBox(public_key_obj)
    encrypted = sealed_box.encrypt(secret_value.encode("utf-8"))
    return base64.b64encode(encrypted).decode("utf-8")

try:
    result = encrypt_secret("$public_key", "$NEW_COOKIE")
    print(result)
except Exception as e:
    print(f"ERROR: {e}", file=sys.stderr)
    exit(1)
EOF
)
                
                if [ $? -eq 0 ] && [ -n "$encrypted_value" ]; then
                  # æ›´æ–° Secret
                  update_response=$(curl -s -X PUT \
                    -H "Authorization: token $GH_TOKEN" \
                    -H "Accept: application/vnd.github.v3+json" \
                    "https://api.github.com/repos/$REPO/actions/secrets/LOGIN_COOKIE" \
                    -d "{\"encrypted_value\":\"$encrypted_value\",\"key_id\":\"$key_id\"}")
                  
                  echo "âœ… Cookie å·²æ›´æ–°åˆ° GitHub Secrets"
                else
                  echo "âš ï¸ Cookie åŠ å¯†å¤±è´¥"
                fi
              else
                echo "âš ï¸ æ— æ³•è·å–å…¬é’¥ï¼Œè·³è¿‡ Cookie æ›´æ–°"
              fi
            else
              echo "âš ï¸ æœªè·å–åˆ°æœ‰æ•ˆçš„æ–° Cookie"
            fi
            
            # æ£€æŸ¥å“åº”å†…å®¹
            if echo "$body" | grep -q "logout\|dashboard\|account"; then
              echo "âœ… ç¡®è®¤å·²ç™»å½•çŠ¶æ€"
            fi
          else
            echo "âŒ ç™»å½•å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $http_code"
            exit 1
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f "$COOKIE_FILE"

      - name: Install PyNaCl
        if: success()
        run: |
          pip install PyNaCl

      - name: Summary
        if: always()
        run: |
          echo "## ç™»å½•ç»“æœ ğŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ• æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ ç›®æ ‡ç½‘ç«™: https://optiklink.com/" >> $GITHUB_STEP_SUMMARY
          if [ $? -eq 0 ]; then
            echo "- âœ… çŠ¶æ€: ç™»å½•æˆåŠŸï¼ŒCookie å·²æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ çŠ¶æ€: ç™»å½•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
