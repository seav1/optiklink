name: Auto Login with Cookie

on:
  schedule:
    # æ¯2å¤©è¿è¡Œä¸€æ¬¡ï¼ŒåŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹ï¼ˆUTC 1:00ï¼‰
    - cron: '0 1 */2 * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  login:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login with Cookie
        run: |
          echo "å¼€å§‹ç™»å½•..."
          
          # ä»Ž GitHub Secrets è¯»å– Cookie
          COOKIE="${{ secrets.LOGIN_COOKIE }}"
          
          # ä½¿ç”¨ curl å‘é€å¸¦ Cookie çš„è¯·æ±‚åˆ°ç™»å½•é¡µé¢
          response=$(curl -s -w "\n%{http_code}" -L \
            -H "Cookie: $COOKIE" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8" \
            -H "Accept-Language: zh-CN,zh;q=0.9,en;q=0.8" \
            "https://optiklink.com/")
          
          # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "HTTP çŠ¶æ€ç : $http_code"
          
          # æ£€æŸ¥æ˜¯å¦ç™»å½•æˆåŠŸ
          if [ "$http_code" = "200" ]; then
            echo "âœ… ç™»å½•æˆåŠŸï¼"
            echo "ç™»å½•æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            
            # å¯é€‰ï¼šæ£€æŸ¥å“åº”å†…å®¹æ˜¯å¦åŒ…å«ç™»å½•åŽçš„ç‰¹å¾
            if echo "$body" | grep -q "logout\|dashboard\|account"; then
              echo "âœ… ç¡®è®¤å·²ç™»å½•çŠ¶æ€"
            else
              echo "âš ï¸ è¯·æ±‚æˆåŠŸä½†å¯èƒ½æœªç™»å½•"
            fi
          else
            echo "âŒ ç™»å½•å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $http_code"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ç™»å½•ç»“æžœ ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ• æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ ç›®æ ‡ç½‘ç«™: https://optiklink.com/" >> $GITHUB_STEP_SUMMARY
          if [ $? -eq 0 ]; then
            echo "- âœ… çŠ¶æ€: ç™»å½•æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ çŠ¶æ€: ç™»å½•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
