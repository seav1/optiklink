name: Auto Login with Cookie

on:
  schedule:
    # æ¯å¤©è¿è¡Œä¸€æ¬¡ï¼ŒåŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹ï¼ˆUTC 1:00ï¼‰
    - cron: '0 1 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  login:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up WARP
        uses: fscarmen/warp-on-actions@v1.4
        with:
          stack: dual        # Optional. Support [ ipv4, ipv6, dual ]. Default is dual.
          mode: wireguard    # Optional. Support [ wireguard, client ]. Default is wireguard.

      - name: Install PyNaCl
        run: |
          pip install PyNaCl

      - name: Login and Update Cookie
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          REPO: ${{ github.repository }}
          OLD_COOKIE: ${{ secrets.LOGIN_COOKIE }}
        run: |
          echo "å¼€å§‹ç™»å½•..."
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨ Cookie å’Œå“åº”å¤´
          COOKIE_FILE=$(mktemp)
          HEADER_FILE=$(mktemp)
          
          # ä½¿ç”¨ curl å‘é€è¯·æ±‚å¹¶ä¿å­˜å“åº”å¤´
          response=$(curl -s -w "\n%{http_code}" -L \
            -D "$HEADER_FILE" \
            -c "$COOKIE_FILE" \
            -b "$OLD_COOKIE" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8" \
            -H "Accept-Language: zh-CN,zh;q=0.9,en;q=0.8" \
            -H "Referer: https://optiklink.com/auth" \
            "https://optiklink.com/")
          
          # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "HTTP çŠ¶æ€ç : $http_code"
          
          # æ£€æŸ¥æ˜¯å¦ç™»å½•æˆåŠŸ
          if [ "$http_code" != "200" ]; then
            echo "âŒ ç™»å½•å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $http_code"
            rm -f "$COOKIE_FILE"
            exit 1
          fi
          
          echo "âœ… ç™»å½•æˆåŠŸï¼"
          echo "ç™»å½•æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # ä»å“åº”å¤´å’Œ Cookie æ–‡ä»¶ä¸­æå–æ–°çš„ Cookie
          NEW_COOKIE=""
          
          echo "æå–æ–°çš„ Cookie..."
          
          # æ–¹æ³•1: ä»å“åº”å¤´çš„ Set-Cookie ä¸­æå–
          if [ -f "$HEADER_FILE" ]; then
            while IFS= read -r line; do
              if [[ "$line" =~ ^[Ss]et-[Cc]ookie:\ (.+)$ ]]; then
                cookie_value="${BASH_REMATCH[1]}"
                # æå– cookie çš„ name=value éƒ¨åˆ†ï¼ˆå»æ‰å…¶ä»–å±æ€§ï¼‰
                cookie_pair=$(echo "$cookie_value" | cut -d';' -f1 | tr -d '\r')
                
                if [ -n "$cookie_pair" ]; then
                  if [ -n "$NEW_COOKIE" ]; then
                    NEW_COOKIE="$NEW_COOKIE; $cookie_pair"
                  else
                    NEW_COOKIE="$cookie_pair"
                  fi
                fi
              fi
            done < "$HEADER_FILE"
          fi
          
          # æ–¹æ³•2: å¦‚æœä»å“åº”å¤´æ²¡è·å–åˆ°ï¼Œå°è¯•ä» cookie æ–‡ä»¶æå–
          if [ -z "$NEW_COOKIE" ] && [ -f "$COOKIE_FILE" ]; then
            echo "å°è¯•ä» Cookie æ–‡ä»¶æå–..."
            while read -r line; do
              # è·³è¿‡æ³¨é‡Šè¡Œ
              if [[ "$line" =~ ^#.* ]] || [ -z "$line" ]; then
                continue
              fi
              
              # Netscape cookie æ ¼å¼: domain flag path secure expiration name value
              name=$(echo "$line" | awk '{print $6}')
              value=$(echo "$line" | awk '{print $7}')
              
              if [ -n "$name" ] && [ -n "$value" ]; then
                if [ -n "$NEW_COOKIE" ]; then
                  NEW_COOKIE="$NEW_COOKIE; $name=$value"
                else
                  NEW_COOKIE="$name=$value"
                fi
              fi
            done < "$COOKIE_FILE"
          fi
          
          # æ–¹æ³•3: å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œä½¿ç”¨æ—§ Cookie
          if [ -z "$NEW_COOKIE" ]; then
            echo "æœªè·å–åˆ°æ–° Cookieï¼Œä½¿ç”¨åŸæœ‰ Cookie"
            NEW_COOKIE="$OLD_COOKIE"
          fi
          
          echo "Cookie å·²æå–"
          echo "Cookie é•¿åº¦: ${#NEW_COOKIE}"
          echo "Cookie å‰50å­—ç¬¦: ${NEW_COOKIE:0:50}..."
          
          # å¦‚æœè·å–åˆ°æ–°çš„ Cookieï¼Œæ›´æ–° GitHub Secret
          if [ -n "$NEW_COOKIE" ] && [ ${#NEW_COOKIE} -gt 10 ]; then
            echo "æ­£åœ¨æ›´æ–° GitHub Secret..."
            
            # è·å– Secret çš„å…¬é’¥
            pub_key_response=$(curl -s -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/actions/secrets/public-key")
            
            key_id=$(echo "$pub_key_response" | jq -r '.key_id')
            public_key=$(echo "$pub_key_response" | jq -r '.key')
            
            if [ -n "$key_id" ] && [ "$key_id" != "null" ] && [ -n "$public_key" ] && [ "$public_key" != "null" ]; then
              # ä½¿ç”¨ Python åŠ å¯† Secret
              cat > /tmp/encrypt_secret.py << 'PYTHON_SCRIPT'
          import base64
          import sys
          import os
          from nacl import encoding, public
          
          def encrypt_secret(public_key_str, secret_value):
              public_key_bytes = base64.b64decode(public_key_str)
              public_key_obj = public.PublicKey(public_key_bytes)
              sealed_box = public.SealedBox(public_key_obj)
              encrypted = sealed_box.encrypt(secret_value.encode("utf-8"))
              return base64.b64encode(encrypted).decode("utf-8")
          
          if __name__ == "__main__":
              pub_key = sys.argv[1]
              secret = sys.argv[2]
              try:
                  result = encrypt_secret(pub_key, secret)
                  print(result)
              except Exception as e:
                  print(f"ERROR: {e}", file=sys.stderr)
                  sys.exit(1)
          PYTHON_SCRIPT
              
              encrypted_value=$(python3 /tmp/encrypt_secret.py "$public_key" "$NEW_COOKIE")
              
              if [ $? -eq 0 ] && [ -n "$encrypted_value" ]; then
                # æ›´æ–° Secret
                update_response=$(curl -s -X PUT \
                  -H "Authorization: token $GH_TOKEN" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "https://api.github.com/repos/$REPO/actions/secrets/LOGIN_COOKIE" \
                  -d "{\"encrypted_value\":\"$encrypted_value\",\"key_id\":\"$key_id\"}")
                
                echo "âœ… Cookie å·²æ›´æ–°åˆ° GitHub Secrets"
              else
                echo "âš ï¸ Cookie åŠ å¯†å¤±è´¥"
              fi
              
              rm -f /tmp/encrypt_secret.py
            else
              echo "âš ï¸ æ— æ³•è·å–å…¬é’¥ï¼Œè·³è¿‡ Cookie æ›´æ–°"
            fi
          else
            echo "âš ï¸ æœªè·å–åˆ°æœ‰æ•ˆçš„æ–° Cookie"
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f "$COOKIE_FILE" "$HEADER_FILE"

      - name: Summary
        if: always()
        run: |
          echo "## ç™»å½•ç»“æœ ğŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ• æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ ç›®æ ‡ç½‘ç«™: https://optiklink.com/" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… çŠ¶æ€: æ‰§è¡Œå®Œæˆ" >> $GITHUB_STEP_SUMMARY
